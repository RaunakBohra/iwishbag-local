<!DOCTYPE html>
<html>
<head>
    <title>Simple eSewa Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        .success { color: green; }
        .error { color: red; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
    <h1>Simple eSewa Test (Port 8083)</h1>
    <p>This tests eSewa form submission from the correct port</p>
    
    <button onclick="testEsewaSubmission()">Test eSewa Submission</button>
    <div id="result"></div>

    <script>
        async function testEsewaSubmission() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p>Testing eSewa submission...</p>';
            
            try {
                // Call backend with full URL
                const response = await fetch('https://grgvlrvywsfmnmkxrecd.supabase.co/functions/v1/create-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdyZ3ZscnZ5d3NmbW5ta3hyZWNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzYzMjg3NTEsImV4cCI6MjA1MTkwNDc1MX0.qpRzQK-7I2JHOBpbVr8G_lLXXJYkxmqRYKLzQDU5lhA'
                    },
                    body: JSON.stringify({
                        quoteIds: ['test-quote-id'],
                        gateway: 'esewa',
                        amount: 100,
                        currency: 'NPR',
                        success_url: 'https://esewa.com.np',
                        cancel_url: 'https://google.com',
                        customerInfo: {
                            name: 'Test Customer',
                            email: 'test@example.com',
                            phone: '9806800001'
                        }
                    })
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                const responseText = await response.text();
                console.log('Response text:', responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                    console.log('Backend response:', data);
                } catch (jsonError) {
                    console.error('JSON parse error:', jsonError);
                    throw new Error(`Invalid JSON response: ${responseText.substring(0, 200)}...`);
                }
                
                if (data.success && data.formData && data.url) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Backend Success!</h4>
                            <p><strong>URL:</strong> ${data.url}</p>
                            <p><strong>Transaction ID:</strong> ${data.transactionId}</p>
                        </div>
                        <button onclick="submitForm('${data.url}', ${JSON.stringify(data.formData).replace(/"/g, '&quot;')})">Submit to eSewa</button>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Backend Error</h4>
                            <p>${data.error || 'Unknown error'}</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Request Failed</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        function submitForm(url, formData) {
            console.log('üìã Creating form with:', url, formData);
            
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = url;
            form.target = '_blank';
            
            Object.entries(formData).forEach(([key, value]) => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = String(value);
                form.appendChild(input);
            });
            
            document.body.appendChild(form);
            
            console.log('üöÄ Submitting form to:', form.action);
            console.log('üìù Form method:', form.method);
            console.log('üìä Form elements:', form.elements.length);
            
            form.submit();
        }
    </script>
</body>
</html>