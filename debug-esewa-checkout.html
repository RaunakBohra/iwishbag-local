<!DOCTYPE html>
<html>
<head>
    <title>Debug eSewa Checkout</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { 
            border: 1px solid #ccc; 
            padding: 15px; 
            margin: 10px 0; 
            background: #f9f9f9;
        }
        button { 
            padding: 10px 20px; 
            background: #007bff; 
            color: white; 
            border: none; 
            cursor: pointer; 
            margin: 5px;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre { background: #f0f0f0; padding: 10px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>Debug eSewa Checkout Issue</h1>
    <p>This tests the exact flow from production checkout</p>
    
    <div class="test-section">
        <h3>Test: Production Backend + New Window</h3>
        <p>This calls the production backend and replicates the new window approach</p>
        <button onclick="testProductionBackend()">Test Production Backend</button>
        <div id="result"></div>
    </div>

    <script>
        async function testProductionBackend() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p class="info">Testing production backend...</p>';
            
            try {
                // Use production backend
                const response = await fetch('https://grgvlrvywsfmnmkxrecd.supabase.co/functions/v1/create-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdyZ3ZscnZ5d3NmbW5ta3hyZWNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzYzMjg3NTEsImV4cCI6MjA1MTkwNDc1MX0.qpRzQK-7I2JHOBpbVr8G_lLXXJYkxmqRYKLzQDU5lhA'
                    },
                    body: JSON.stringify({
                        quoteIds: ['test-quote-id'],
                        gateway: 'esewa',
                        amount: 100,
                        currency: 'NPR',
                        success_url: 'https://esewa.com.np',
                        cancel_url: 'https://google.com',
                        customerInfo: {
                            name: 'Test Customer',
                            email: 'test@example.com',
                            phone: '9806800001'
                        }
                    })
                });
                
                const data = await response.json();
                console.log('Production backend response:', data);
                
                if (data.success && data.formData && data.url) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Production Backend Success!</h4>
                            <p><strong>URL:</strong> ${data.url}</p>
                            <p><strong>Method:</strong> ${data.method}</p>
                            <p><strong>Transaction ID:</strong> ${data.transactionId}</p>
                        </div>
                    `;
                    
                    // Clean URL (exactly like checkout does)
                    let cleanUrl = data.url;
                    if (cleanUrl.includes('e%20%20pay') || cleanUrl.includes('e  pay')) {
                        console.log('üîß Cleaning corrupted URL:', cleanUrl);
                        cleanUrl = cleanUrl.replace(/e\s+pay/g, 'epay').replace(/e%20%20pay/g, 'epay');
                        console.log('üîß Fixed URL:', cleanUrl);
                    }
                    
                    // Validate URL format
                    const expectedTestUrl = 'https://rc-epay.esewa.com.np/api/epay/main/v2/form';
                    const expectedLiveUrl = 'https://epay.esewa.com.np/api/epay/main/v2/form';
                    if (cleanUrl !== expectedTestUrl && cleanUrl !== expectedLiveUrl) {
                        console.error('‚ùå Unexpected eSewa URL:', cleanUrl);
                        console.error('‚ùå Expected:', expectedTestUrl, 'or', expectedLiveUrl);
                        throw new Error('Invalid eSewa URL format');
                    }
                    
                    // Create form HTML exactly like checkout
                    const formHTML = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>eSewa Payment</title>
                            <style>
                                body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
                                .loading { font-size: 18px; color: #666; }
                            </style>
                        </head>
                        <body>
                            <div class="loading">Redirecting to eSewa...</div>
                            <form id="esewaForm" method="POST" action="${cleanUrl}" style="display: none;">
                                ${Object.entries(data.formData)
                                    .map(([key, value]) => 
                                        `<input type="hidden" name="${key}" value="${String(value)}">`
                                    )
                                    .join('')}
                            </form>
                            <script>
                                console.log('Form created in new window');
                                console.log('Method:', document.getElementById('esewaForm').method);
                                console.log('Action:', document.getElementById('esewaForm').action);
                                console.log('Form HTML:', document.getElementById('esewaForm').outerHTML);
                                
                                // Log all form fields
                                const form = document.getElementById('esewaForm');
                                for (let i = 0; i < form.elements.length; i++) {
                                    const element = form.elements[i];
                                    console.log('Field:', element.name, '=', element.value);
                                }
                                
                                // Submit immediately
                                setTimeout(() => {
                                    console.log('About to submit form...');
                                    document.getElementById('esewaForm').submit();
                                }, 100);
                            </script>
                        </body>
                        </html>
                    `;
                    
                    // Open new window and write the form
                    const paymentWindow = window.open('', '_blank', 'width=800,height=600');
                    if (paymentWindow) {
                        paymentWindow.document.write(formHTML);
                        paymentWindow.document.close();
                        resultDiv.innerHTML += '<p class="success">‚úÖ eSewa form submitted in new window</p>';
                    } else {
                        resultDiv.innerHTML += '<p class="error">‚ùå Failed to open new window (pop-up blocked?)</p>';
                    }
                    
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Production Backend Error</h4>
                            <p><strong>Error:</strong> ${data.error || 'Unknown error'}</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Request Failed</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
            }
        }
        
        console.log('Debug eSewa checkout page loaded');
    </script>
</body>
</html>