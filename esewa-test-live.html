<!doctype html>
<html>
  <head>
    <title>eSewa v2 Live Test</title>
    <meta charset="UTF-8" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/hmac-sha256.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/enc-base64.min.js"></script>
  </head>
  <body>
    <h1>eSewa v2 Live Test</h1>
    <p>This will test the exact implementation that's causing the 405 error</p>

    <div id="debug"></div>

    <script>
      // Use current timestamp for transaction UUID
      const currentTime = new Date();
      const transactionUuid =
        currentTime.toISOString().slice(2, 10).replace(/-/g, '') +
        '-' +
        currentTime.getHours() +
        currentTime.getMinutes() +
        currentTime.getSeconds();

      // Your actual implementation parameters
      const params = {
        amount: '100',
        tax_amount: '0',
        total_amount: '100',
        transaction_uuid: transactionUuid,
        product_code: 'EPAYTEST',
        product_service_charge: '0',
        product_delivery_charge: '0',
        success_url: window.location.origin + '/success',
        failure_url: window.location.origin + '/failure',
        signed_field_names: 'total_amount,transaction_uuid,product_code,',
      };

      // Generate signature (using test secret)
      const signatureString = `total_amount=${params.total_amount},transaction_uuid=${params.transaction_uuid},product_code=${params.product_code}`;
      const hash = CryptoJS.HmacSHA256(signatureString, '8gBm/:&EnhH.1/q');
      const signature = CryptoJS.enc.Base64.stringify(hash);

      params.signature = signature;

      // Debug output
      const debugDiv = document.getElementById('debug');
      debugDiv.innerHTML = `
            <h2>Debug Info:</h2>
            <p><strong>URL:</strong> https://rc-epay.esewa.com.np/api/epay/main/v2/form</p>
            <p><strong>Method:</strong> POST</p>
            <p><strong>Transaction UUID:</strong> ${params.transaction_uuid}</p>
            <p><strong>Signature String:</strong> ${signatureString}</p>
            <p><strong>Generated Signature:</strong> ${signature}</p>
            <p><strong>All Parameters:</strong></p>
            <pre>${JSON.stringify(params, null, 2)}</pre>
        `;

      // Create form programmatically (exactly like your Checkout.tsx)
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = 'https://rc-epay.esewa.com.np/api/epay/main/v2/form';
      form.target = '_self';

      // Add all parameters as hidden fields
      Object.entries(params).forEach(([key, value]) => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = String(value);
        form.appendChild(input);
      });

      // Add submit button for manual testing
      const submitButton = document.createElement('input');
      submitButton.type = 'submit';
      submitButton.value = 'Pay with eSewa (Test)';
      submitButton.style.padding = '10px 20px';
      submitButton.style.fontSize = '16px';
      submitButton.style.backgroundColor = '#4CAF50';
      submitButton.style.color = 'white';
      submitButton.style.border = 'none';
      submitButton.style.cursor = 'pointer';
      form.appendChild(submitButton);

      document.body.appendChild(form);

      console.log('Form created with method:', form.method);
      console.log('Form action:', form.action);
      console.log('Form elements count:', form.elements.length);

      // Log each form element
      Array.from(form.elements).forEach((element) => {
        if (element.type === 'hidden') {
          console.log(`Hidden field: ${element.name} = ${element.value}`);
        }
      });
    </script>
  </body>
</html>
