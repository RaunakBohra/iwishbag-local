<!DOCTYPE html>
<html>
<head>
    <title>Test Signature Validation</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ccc; padding: 15px; margin: 10px 0; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre { background: #f0f0f0; padding: 10px; border-radius: 4px; font-size: 12px; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
    <h1>Test Signature Validation</h1>
    <p>This tests if our signature generation matches eSewa's expected format</p>
    
    <div class="test-section">
        <h3>Test: Backend vs Manual Signature</h3>
        <button onclick="testSignatureComparison()">Test Signature Comparison</button>
        <div id="result"></div>
    </div>

    <script>
        function generateManualSignature(total_amount, transaction_uuid, product_code) {
            const signatureString = `total_amount=${total_amount},transaction_uuid=${transaction_uuid},product_code=${product_code}`;
            const secretKey = '8gBm/:&EnhH.1/q';
            
            console.log('üîê Manual signature generation:');
            console.log('  String to sign:', signatureString);
            console.log('  Secret key:', secretKey);
            
            const hash = CryptoJS.HmacSHA256(signatureString, secretKey);
            const signature = CryptoJS.enc.Base64.stringify(hash);
            
            console.log('  Generated signature:', signature);
            return signature;
        }

        async function testSignatureComparison() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p class="info">Testing signature comparison...</p>';
            
            try {
                // Test parameters
                const testParams = {
                    total_amount: '100',
                    transaction_uuid: '250717-114500',
                    product_code: 'EPAYTEST'
                };
                
                // Generate manual signature
                const manualSignature = generateManualSignature(
                    testParams.total_amount,
                    testParams.transaction_uuid,
                    testParams.product_code
                );
                
                // Get backend signature
                const response = await fetch('https://grgvlrvywsfmnmkxrecd.supabase.co/functions/v1/create-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdyZ3ZscnZ5d3NmbW5ta3hyZWNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzYzMjg3NTEsImV4cCI6MjA1MTkwNDc1MX0.qpRzQK-7I2JHOBpbVr8G_lLXXJYkxmqRYKLzQDU5lhA'
                    },
                    body: JSON.stringify({
                        quoteIds: ['test-quote-id'],
                        gateway: 'esewa',
                        amount: 100,
                        currency: 'NPR',
                        success_url: 'https://esewa.com.np',
                        cancel_url: 'https://google.com',
                        customerInfo: {
                            name: 'Test Customer',
                            email: 'test@example.com',
                            phone: '9806800001'
                        }
                    })
                });
                
                const backendData = await response.json();
                
                if (backendData.success && backendData.formData) {
                    const backendSignature = backendData.formData.signature;
                    const backendSignedFields = backendData.formData.signed_field_names;
                    
                    console.log('üîç Backend signature comparison:');
                    console.log('  Backend signature:', backendSignature);
                    console.log('  Manual signature:', manualSignature);
                    console.log('  Signatures match:', backendSignature === manualSignature);
                    console.log('  Backend signed_field_names:', backendSignedFields);
                    
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Signature Comparison Results</h4>
                            <p><strong>Backend Signature:</strong></p>
                            <pre>${backendSignature}</pre>
                            <p><strong>Manual Signature:</strong></p>
                            <pre>${manualSignature}</pre>
                            <p><strong>Match:</strong> ${backendSignature === manualSignature ? '‚úÖ YES' : '‚ùå NO'}</p>
                            <p><strong>Signed Fields:</strong> ${backendSignedFields}</p>
                        </div>
                        
                        <h4>Backend Form Data:</h4>
                        <pre>${JSON.stringify(backendData.formData, null, 2)}</pre>
                    `;
                    
                    // Test form submission with backend data
                    if (backendSignature !== manualSignature) {
                        resultDiv.innerHTML += '<p class="error">‚ùå Signature mismatch detected! This could cause 405 errors.</p>';
                    } else {
                        resultDiv.innerHTML += '<p class="success">‚úÖ Signatures match! Problem likely elsewhere.</p>';
                        
                        // Test actual form submission with backend data
                        const testButton = document.createElement('button');
                        testButton.textContent = 'Test Form Submission with Backend Data';
                        testButton.onclick = () => testFormSubmission(backendData);
                        resultDiv.appendChild(testButton);
                    }
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Backend Error</h4>
                            <p><strong>Error:</strong> ${backendData.error || 'Unknown error'}</p>
                            <pre>${JSON.stringify(backendData, null, 2)}</pre>
                        </div>
                    `;
                }
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Test Failed</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
            }
        }
        
        function testFormSubmission(backendData) {
            console.log('üß™ Testing form submission with backend data...');
            
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = backendData.url;
            form.target = '_blank';
            
            Object.entries(backendData.formData).forEach(([key, value]) => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = String(value);
                form.appendChild(input);
            });
            
            document.body.appendChild(form);
            
            console.log('üìã Form ready for submission:');
            console.log('  Method:', form.method);
            console.log('  Action:', form.action);
            console.log('  Elements:', form.elements.length);
            
            setTimeout(() => {
                form.submit();
            }, 1000);
        }
        
        console.log('Signature validation test page loaded');
    </script>
</body>
</html>