<!DOCTYPE html>
<html>
<head>
    <title>Test Checkout Replication</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ccc; padding: 15px; margin: 10px 0; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre { background: #f0f0f0; padding: 10px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>Test Checkout Replication</h1>
    <p>This exactly replicates the checkout form creation and submission process</p>
    
    <div class="test-section">
        <h3>Test: Exact Checkout Flow</h3>
        <button onclick="testExactCheckoutFlow()">Test Exact Checkout Flow</button>
        <div id="result"></div>
    </div>

    <script>
        async function testExactCheckoutFlow() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p class="info">Starting exact checkout flow test...</p>';
            
            try {
                // Step 1: Call production backend exactly like checkout does
                const response = await fetch('https://grgvlrvywsfmnmkxrecd.supabase.co/functions/v1/create-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdyZ3ZscnZ5d3NmbW5ta3hyZWNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzYzMjg3NTEsImV4cCI6MjA1MTkwNDc1MX0.qpRzQK-7I2JHOBpbVr8G_lLXXJYkxmqRYKLzQDU5lhA'
                    },
                    body: JSON.stringify({
                        quoteIds: ['test-quote-id'],
                        gateway: 'esewa',
                        amount: 100,
                        currency: 'NPR',
                        success_url: 'https://esewa.com.np',
                        cancel_url: 'https://google.com',
                        customerInfo: {
                            name: 'Test Customer',
                            email: 'test@example.com',
                            phone: '9806800001'
                        }
                    })
                });
                
                const paymentResponse = await response.json();
                console.log('üîç eSewa payment response:', paymentResponse);
                
                if (!paymentResponse.success) {
                    throw new Error(paymentResponse.error || 'Payment creation failed');
                }
                
                resultDiv.innerHTML += '<p class="success">‚úÖ Backend call successful</p>';
                
                // Step 2: Process response exactly like checkout does
                if (paymentResponse.url) {
                    console.log('üîç Has formData?', !!paymentResponse.formData);
                    console.log('üîç Has URL?', !!paymentResponse.url);
                    console.log('üîç Method?', paymentResponse.method);

                    // Clean URL exactly like checkout
                    let cleanUrl = paymentResponse.url;
                    if (cleanUrl.includes('e%20%20pay') || cleanUrl.includes('e  pay')) {
                        console.log('üîß Cleaning corrupted URL:', cleanUrl);
                        cleanUrl = cleanUrl.replace(/e\\s+pay/g, 'epay').replace(/e%20%20pay/g, 'epay');
                        console.log('üîß Fixed URL:', cleanUrl);
                    }

                    // Validate URL format exactly like checkout
                    const expectedTestUrl = 'https://rc-epay.esewa.com.np/api/epay/main/v2/form';
                    const expectedLiveUrl = 'https://epay.esewa.com.np/api/epay/main/v2/form';
                    if (cleanUrl !== expectedTestUrl && cleanUrl !== expectedLiveUrl) {
                        console.error('‚ùå Unexpected eSewa URL:', cleanUrl);
                        console.error('‚ùå Expected:', expectedTestUrl, 'or', expectedLiveUrl);
                        throw new Error('Invalid eSewa URL format');
                    }

                    resultDiv.innerHTML += '<p class="success">‚úÖ URL validation passed</p>';

                    // Step 3: Create form HTML exactly like checkout
                    const formHTML = \`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>eSewa Payment</title>
                            <style>
                                body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
                                .loading { font-size: 18px; color: #666; }
                            </style>
                        </head>
                        <body>
                            <div class="loading">Redirecting to eSewa...</div>
                            <form id="esewaForm" method="POST" action="\${cleanUrl}" style="display: none;">
                                \${Object.entries(paymentResponse.formData)
                                    .map(([key, value]) => 
                                        \`<input type="hidden" name="\${key}" value="\${String(value)}">\`
                                    )
                                    .join('')}
                            </form>
                            <script>
                                console.log('Form created in new window');
                                console.log('Method:', document.getElementById('esewaForm').method);
                                console.log('Action:', document.getElementById('esewaForm').action);
                                console.log('Form HTML:', document.getElementById('esewaForm').outerHTML);
                                
                                // Log all form fields
                                const form = document.getElementById('esewaForm');
                                console.log('Form elements count:', form.elements.length);
                                for (let i = 0; i < form.elements.length; i++) {
                                    const element = form.elements[i];
                                    console.log('Field ' + i + ':', element.name, '=', element.value);
                                }
                                
                                // Validate form before submission
                                console.log('Form method before submit:', form.method);
                                console.log('Form action before submit:', form.action);
                                console.log('Form target before submit:', form.target);
                                
                                // Submit immediately
                                setTimeout(() => {
                                    console.log('About to submit form...');
                                    try {
                                        form.submit();
                                        console.log('Form submitted successfully!');
                                    } catch (error) {
                                        console.error('Form submission error:', error);
                                    }
                                }, 500);
                            </script>
                        </body>
                        </html>
                    \`;

                    // Step 4: Open new window and write form exactly like checkout
                    const paymentWindow = window.open('', '_blank', 'width=800,height=600');
                    if (paymentWindow) {
                        paymentWindow.document.write(formHTML);
                        paymentWindow.document.close();
                        resultDiv.innerHTML += '<p class="success">‚úÖ eSewa form submitted in new window</p>';
                        
                        // Monitor the new window
                        const checkWindow = setInterval(() => {
                            if (paymentWindow.closed) {
                                clearInterval(checkWindow);
                                resultDiv.innerHTML += '<p class="info">‚ÑπÔ∏è Payment window closed</p>';
                            }
                        }, 1000);
                        
                    } else {
                        resultDiv.innerHTML += '<p class="error">‚ùå Failed to open new window (pop-up blocked?)</p>';
                    }
                } else {
                    throw new Error('No URL in payment response');
                }
                
            } catch (error) {
                resultDiv.innerHTML += \`
                    <div class="error">
                        <h4>‚ùå Test Failed</h4>
                        <p><strong>Error:</strong> \${error.message}</p>
                    </div>
                \`;
                console.error('Test failed:', error);
            }
        }
        
        console.log('Test checkout replication page loaded');
    </script>
</body>
</html>