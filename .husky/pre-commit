#!/usr/bin/env sh

# iwishBag Pre-commit Hook
# Prevents commits with schema issues or missing imports

echo "🔍 Running pre-commit validation..."

# Check TypeScript compilation for missing imports
echo "📝 Checking TypeScript compilation..."
npm run typecheck
if [ $? -ne 0 ]; then
  echo "❌ TypeScript compilation failed - check for missing imports"
  exit 1
fi

# Run ESLint to catch other issues
echo "🧹 Running ESLint..."
npm run lint
if [ $? -ne 0 ]; then
  echo "❌ ESLint found issues"
  exit 1
fi

# If local database is running, validate schema
if command -v supabase >/dev/null 2>&1; then
  if supabase status | grep -q "DB.*running"; then
    echo "🗄️ Local database detected, running schema validation..."
    npm run validate-schema
    if [ $? -ne 0 ]; then
      echo "❌ Schema validation failed"
      echo "💡 Run: npm run db:verify-schema"
      exit 1
    fi
  else
    echo "⚠️ Local database not running, skipping schema validation"
  fi
else
  echo "⚠️ Supabase CLI not found, skipping schema validation"
fi

echo "✅ Pre-commit validation passed!"