<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Isolate eSewa Issue</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { background: #f0f0f0; padding: 15px; margin: 10px 0; border-radius: 5px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>Isolate eSewa Issue</h1>
    
    <div class="result">
        <h3>Test: Backend + Form Submission</h3>
        <button onclick="testBackendAndSubmit()">Test Full Flow</button>
        <div id="result"></div>
    </div>

    <script>
        async function testBackendAndSubmit() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p>Testing backend...</p>';
            
            try {
                // 1. Call backend to get form data
                const response = await fetch('/functions/v1/create-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        quoteIds: ['test-quote-' + Date.now()],
                        gateway: 'esewa',
                        amount: 100,
                        currency: 'NPR',
                        success_url: window.location.origin + '/payment-callback/esewa-success',
                        cancel_url: window.location.origin + '/payment-callback/esewa-failure',
                        customerInfo: {
                            name: 'Test Customer',
                            email: 'test@example.com',
                            phone: '9806800001'
                        }
                    })
                });
                
                const paymentResponse = await response.json();
                
                if (paymentResponse.success && paymentResponse.formData && paymentResponse.url) {
                    resultDiv.innerHTML = `
                        <p>✅ Backend response received</p>
                        <p><strong>URL:</strong> ${paymentResponse.url}</p>
                        <p><strong>Method:</strong> ${paymentResponse.method}</p>
                        <p><strong>Fields:</strong> ${Object.keys(paymentResponse.formData).length}</p>
                        <p>Creating form...</p>
                    `;
                    
                    // 2. Create form exactly like checkout does
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = paymentResponse.url;
                    form.target = '_blank';
                    form.style.display = 'none';
                    
                    // Force POST method
                    form.setAttribute('method', 'POST');
                    
                    // Add all form fields
                    Object.entries(paymentResponse.formData).forEach(([key, value]) => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = key;
                        input.value = String(value);
                        form.appendChild(input);
                    });
                    
                    document.body.appendChild(form);
                    
                    resultDiv.innerHTML += `
                        <p>✅ Form created with ${form.elements.length} fields</p>
                        <p>Submitting...</p>
                    `;
                    
                    // 3. Submit form
                    console.log('Form before submit:', {
                        method: form.method,
                        action: form.action,
                        fieldCount: form.elements.length
                    });
                    
                    // Try multiple submission methods
                    try {
                        form.submit();
                        resultDiv.innerHTML += `<p>✅ Form submitted via form.submit()</p>`;
                    } catch (error) {
                        resultDiv.innerHTML += `<p>❌ form.submit() failed: ${error.message}</p>`;
                        
                        // Try button click method
                        try {
                            const submitButton = document.createElement('button');
                            submitButton.type = 'submit';
                            submitButton.style.display = 'none';
                            form.appendChild(submitButton);
                            
                            submitButton.click();
                            resultDiv.innerHTML += `<p>✅ Form submitted via button.click()</p>`;
                        } catch (buttonError) {
                            resultDiv.innerHTML += `<p>❌ button.click() failed: ${buttonError.message}</p>`;
                        }
                    }
                    
                } else {
                    resultDiv.innerHTML = `
                        <p>❌ Backend error</p>
                        <pre>${JSON.stringify(paymentResponse, null, 2)}</pre>
                    `;
                }
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <p>❌ Request failed: ${error.message}</p>
                `;
            }
        }
    </script>
</body>
</html>