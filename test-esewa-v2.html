<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eSewa v2 API Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/hmac-sha256.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/enc-base64.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: inline-block;
            width: 200px;
            font-weight: bold;
        }
        input[type="text"] {
            width: 300px;
            padding: 5px;
        }
        .signature-info {
            background-color: #f0f0f0;
            padding: 10px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .submit-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .submit-btn:hover {
            background-color: #45a049;
        }
        .comparison {
            margin-top: 20px;
            padding: 10px;
            background-color: #e8f4f8;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>eSewa v2 API Test - iwishBag Integration</h1>
    
    <div class="comparison">
        <h3>Configuration Check:</h3>
        <p><strong>Secret Key:</strong> 8gBm/:&EnhH.1/q (from demo)</p>
        <p><strong>Product Code:</strong> EPAYTEST</p>
        <p><strong>API URL:</strong> https://rc-epay.esewa.com.np/api/epay/main/v2/form</p>
    </div>

    <form id="esewaForm" action="https://rc-epay.esewa.com.np/api/epay/main/v2/form" method="POST">
        <div class="form-group">
            <label>Amount:</label>
            <input type="text" id="amount" name="amount" value="100" required>
        </div>
        
        <div class="form-group">
            <label>Tax Amount:</label>
            <input type="text" id="tax_amount" name="tax_amount" value="0" required>
        </div>
        
        <div class="form-group">
            <label>Total Amount:</label>
            <input type="text" id="total_amount" name="total_amount" value="100" required>
        </div>
        
        <div class="form-group">
            <label>Transaction UUID:</label>
            <input type="text" id="transaction_uuid" name="transaction_uuid" value="" required>
        </div>
        
        <div class="form-group">
            <label>Product Code:</label>
            <input type="text" id="product_code" name="product_code" value="EPAYTEST" required>
        </div>
        
        <div class="form-group">
            <label>Product Service Charge:</label>
            <input type="text" id="product_service_charge" name="product_service_charge" value="0" required>
        </div>
        
        <div class="form-group">
            <label>Product Delivery Charge:</label>
            <input type="text" id="product_delivery_charge" name="product_delivery_charge" value="0" required>
        </div>
        
        <div class="form-group">
            <label>Success URL:</label>
            <input type="text" id="success_url" name="success_url" value="http://localhost:5173/payment-callback/esewa-success" required>
        </div>
        
        <div class="form-group">
            <label>Failure URL:</label>
            <input type="text" id="failure_url" name="failure_url" value="http://localhost:5173/payment-callback/esewa-failure" required>
        </div>
        
        <div class="form-group">
            <label>Signed Field Names:</label>
            <input type="text" id="signed_field_names" name="signed_field_names" value="total_amount,transaction_uuid,product_code" readonly>
        </div>
        
        <div class="form-group">
            <label>Signature:</label>
            <input type="text" id="signature" name="signature" value="" required>
        </div>
        
        <div class="signature-info">
            <h3>Signature Generation Info:</h3>
            <p><strong>String to Sign:</strong> <span id="signatureString"></span></p>
            <p><strong>Secret Key:</strong> 8gBm/:&EnhH.1/q</p>
            <p><strong>Generated Signature:</strong> <span id="generatedSignature"></span></p>
        </div>
        
        <button type="submit" class="submit-btn">Pay with eSewa</button>
    </form>

    <script>
        // Generate transaction UUID on page load
        function generateTransactionUuid() {
            const currentTime = new Date();
            const uuid = currentTime.toISOString().slice(2, 10).replace(/-/g, '') + 
                '-' + currentTime.getHours() + currentTime.getMinutes() + currentTime.getSeconds();
            document.getElementById('transaction_uuid').value = uuid;
        }

        // Generate signature
        function generateSignature() {
            const total_amount = document.getElementById('total_amount').value;
            const transaction_uuid = document.getElementById('transaction_uuid').value;
            const product_code = document.getElementById('product_code').value;
            
            // Create signature string in the exact format
            const signatureString = `total_amount=${total_amount},transaction_uuid=${transaction_uuid},product_code=${product_code}`;
            document.getElementById('signatureString').textContent = signatureString;
            
            // Generate HMAC-SHA256 signature
            const secretKey = '8gBm/:&EnhH.1/q';
            const hash = CryptoJS.HmacSHA256(signatureString, secretKey);
            const hashInBase64 = CryptoJS.enc.Base64.stringify(hash);
            
            document.getElementById('signature').value = hashInBase64;
            document.getElementById('generatedSignature').textContent = hashInBase64;
            
            console.log('Signature String:', signatureString);
            console.log('Generated Signature:', hashInBase64);
        }

        // Initialize on page load
        generateTransactionUuid();
        generateSignature();

        // Update signature when values change
        document.getElementById('total_amount').addEventListener('input', generateSignature);
        document.getElementById('transaction_uuid').addEventListener('input', generateSignature);
        document.getElementById('product_code').addEventListener('input', generateSignature);

        // Update total amount when amount changes
        document.getElementById('amount').addEventListener('input', function() {
            const amount = parseFloat(this.value) || 0;
            const tax = parseFloat(document.getElementById('tax_amount').value) || 0;
            document.getElementById('total_amount').value = amount + tax;
            generateSignature();
        });

        document.getElementById('tax_amount').addEventListener('input', function() {
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            const tax = parseFloat(this.value) || 0;
            document.getElementById('total_amount').value = amount + tax;
            generateSignature();
        });

        // Form submission
        document.getElementById('esewaForm').addEventListener('submit', function(e) {
            e.preventDefault();
            generateSignature();
            
            // Log form data before submission
            const formData = new FormData(this);
            console.log('Submitting form with data:');
            for (let [key, value] of formData.entries()) {
                console.log(`${key}: ${value}`);
            }
            
            // Submit the form
            this.submit();
        });
    </script>
</body>
</html>