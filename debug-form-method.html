<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Form Method</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test { background: #f0f0f0; padding: 15px; margin: 10px 0; border-radius: 5px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; margin: 5px; }
        .result { margin: 10px 0; padding: 10px; background: #e8f4f8; border-radius: 5px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Debug Form Method Issue</h1>
    
    <div class="test">
        <h3>Test 1: Direct Form Creation (like your working test)</h3>
        <button onclick="testDirectForm()">Test Direct Form</button>
        <div id="result1"></div>
    </div>
    
    <div class="test">
        <h3>Test 2: Dynamic Form Creation (like checkout)</h3>
        <button onclick="testDynamicForm()">Test Dynamic Form</button>
        <div id="result2"></div>
    </div>
    
    <div class="test">
        <h3>Test 3: Call Backend + Submit Form</h3>
        <button onclick="testBackendAndSubmit()">Test Backend + Submit</button>
        <div id="result3"></div>
    </div>
    
    <div class="test">
        <h3>Test 4: Force POST with fetch</h3>
        <button onclick="testForcePOST()">Test Force POST</button>
        <div id="result4"></div>
    </div>

    <script>
        function testDirectForm() {
            const result = document.getElementById('result1');
            result.innerHTML = '<p>Creating direct form...</p>';
            
            // Create form exactly like your working test
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = 'https://rc-epay.esewa.com.np/api/epay/main/v2/form';
            form.target = '_blank';
            
            const formData = {
                amount: '100',
                tax_amount: '0',
                total_amount: '100',
                transaction_uuid: '250117-' + Date.now(),
                product_code: 'EPAYTEST',
                product_service_charge: '0',
                product_delivery_charge: '0',
                success_url: 'https://esewa.com.np',
                failure_url: 'https://google.com',
                signed_field_names: 'total_amount,transaction_uuid,product_code',
                signature: 'test_signature'
            };
            
            Object.entries(formData).forEach(([key, value]) => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = value;
                form.appendChild(input);
            });
            
            document.body.appendChild(form);
            
            result.innerHTML = `
                <p>✅ Form created</p>
                <p>Method: ${form.method}</p>
                <p>Action: ${form.action}</p>
                <p>Fields: ${form.elements.length}</p>
            `;
            
            setTimeout(() => {
                try {
                    form.submit();
                    result.innerHTML += '<p>✅ Form submitted successfully</p>';
                } catch (error) {
                    result.innerHTML += '<p>❌ Form submission failed: ' + error.message + '</p>';
                }
            }, 1000);
        }
        
        function testDynamicForm() {
            const result = document.getElementById('result2');
            result.innerHTML = '<p>Creating dynamic form...</p>';
            
            // Create form dynamically like checkout does
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = 'https://rc-epay.esewa.com.np/api/epay/main/v2/form';
            form.target = '_blank';
            form.style.display = 'none';
            
            // Force POST method
            form.setAttribute('method', 'POST');
            
            const formData = {
                amount: '100',
                tax_amount: '0',
                total_amount: '100',
                transaction_uuid: '250117-' + Date.now(),
                product_code: 'EPAYTEST',
                product_service_charge: '0',
                product_delivery_charge: '0',
                success_url: 'https://esewa.com.np',
                failure_url: 'https://google.com',
                signed_field_names: 'total_amount,transaction_uuid,product_code',
                signature: 'test_signature'
            };
            
            Object.entries(formData).forEach(([key, value]) => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = String(value);
                form.appendChild(input);
            });
            
            document.body.appendChild(form);
            
            result.innerHTML = `
                <p>✅ Form created</p>
                <p>Method: ${form.method}</p>
                <p>getAttribute('method'): ${form.getAttribute('method')}</p>
                <p>Action: ${form.action}</p>
                <p>Fields: ${form.elements.length}</p>
            `;
            
            setTimeout(() => {
                try {
                    form.submit();
                    result.innerHTML += '<p>✅ Form submitted successfully</p>';
                } catch (error) {
                    result.innerHTML += '<p>❌ Form submission failed: ' + error.message + '</p>';
                }
            }, 1000);
        }
        
        async function testBackendAndSubmit() {
            const result = document.getElementById('result3');
            result.innerHTML = '<p>Calling backend...</p>';
            
            try {
                const response = await fetch('/functions/v1/create-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        quoteIds: ['test-quote-' + Date.now()],
                        gateway: 'esewa',
                        amount: 100,
                        currency: 'NPR',
                        success_url: window.location.origin + '/payment-callback/esewa-success',
                        cancel_url: window.location.origin + '/payment-callback/esewa-failure',
                        customerInfo: {
                            name: 'Test Customer',
                            email: 'test@example.com',
                            phone: '9806800001'
                        }
                    })
                });
                
                const paymentResponse = await response.json();
                
                if (paymentResponse.success && paymentResponse.formData && paymentResponse.url) {
                    result.innerHTML = `
                        <p>✅ Backend response received</p>
                        <p>URL: ${paymentResponse.url}</p>
                        <p>Method: ${paymentResponse.method}</p>
                        <p>Creating form...</p>
                    `;
                    
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = paymentResponse.url;
                    form.target = '_blank';
                    form.style.display = 'none';
                    
                    Object.entries(paymentResponse.formData).forEach(([key, value]) => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = key;
                        input.value = String(value);
                        form.appendChild(input);
                    });
                    
                    document.body.appendChild(form);
                    
                    result.innerHTML += `
                        <p>✅ Form created with ${form.elements.length} fields</p>
                        <p>Submitting...</p>
                    `;
                    
                    setTimeout(() => {
                        try {
                            form.submit();
                            result.innerHTML += '<p>✅ Form submitted successfully</p>';
                        } catch (error) {
                            result.innerHTML += '<p>❌ Form submission failed: ' + error.message + '</p>';
                        }
                    }, 1000);
                    
                } else {
                    result.innerHTML = `
                        <p>❌ Backend error</p>
                        <pre>${JSON.stringify(paymentResponse, null, 2)}</pre>
                    `;
                }
                
            } catch (error) {
                result.innerHTML = `<p>❌ Request failed: ${error.message}</p>`;
            }
        }
        
        async function testForcePOST() {
            const result = document.getElementById('result4');
            result.innerHTML = '<p>Forcing POST with fetch...</p>';
            
            const formData = new FormData();
            formData.append('amount', '100');
            formData.append('tax_amount', '0');
            formData.append('total_amount', '100');
            formData.append('transaction_uuid', '250117-' + Date.now());
            formData.append('product_code', 'EPAYTEST');
            formData.append('product_service_charge', '0');
            formData.append('product_delivery_charge', '0');
            formData.append('success_url', 'https://esewa.com.np');
            formData.append('failure_url', 'https://google.com');
            formData.append('signed_field_names', 'total_amount,transaction_uuid,product_code');
            formData.append('signature', 'test_signature');
            
            try {
                const response = await fetch('https://rc-epay.esewa.com.np/api/epay/main/v2/form', {
                    method: 'POST',
                    body: formData
                });
                
                result.innerHTML = `
                    <p>✅ Fetch response received</p>
                    <p>Status: ${response.status}</p>
                    <p>OK: ${response.ok}</p>
                    <p>URL: ${response.url}</p>
                `;
                
                if (response.ok) {
                    // Open in new tab
                    const responseText = await response.text();
                    const newTab = window.open('', '_blank');
                    newTab.document.write(responseText);
                    result.innerHTML += '<p>✅ Response opened in new tab</p>';
                }
                
            } catch (error) {
                result.innerHTML = `<p>❌ Fetch failed: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>