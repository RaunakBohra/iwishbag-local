<!doctype html>
<html>
  <head>
    <title>PayU Test with Correct Keys</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        max-width: 600px;
        margin: 0 auto;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      button {
        background: #4caf50;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin: 10px 0;
        width: 100%;
      }
      button:hover {
        background: #45a049;
      }
      .info {
        background: #e3f2fd;
        padding: 15px;
        border-radius: 5px;
        margin: 15px 0;
        border-left: 4px solid #2196f3;
      }
      .success {
        background: #e8f5e8;
        border-left-color: #4caf50;
      }
      .log {
        background: #f8f8f8;
        padding: 15px;
        border-radius: 5px;
        margin: 15px 0;
        font-family: monospace;
        font-size: 12px;
        max-height: 200px;
        overflow-y: auto;
      }
      pre {
        background: #f0f0f0;
        padding: 10px;
        border-radius: 3px;
        overflow-x: auto;
        font-size: 11px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>PayU Test with Your Actual Keys</h1>

      <div class="info">
        <h3>ðŸŽ¯ Purpose</h3>
        <p>
          This test uses your actual PayU test keys from the database and generates a proper SHA-512
          hash.
        </p>
        <p><strong>Keys:</strong> rjQUPktU / e5iIg1jwi8UnzIZJJP9hK43y9PNYvBKBSFMvVHrOHx</p>
      </div>

      <button onclick="testPayUPayment()">ðŸš€ Test PayU Payment with Correct Keys & Hash</button>

      <div id="logOutput" class="log"></div>

      <div class="info success">
        <h3>âœ… Expected Result</h3>
        <p>
          If everything works correctly, PayU should accept the payment and redirect to their
          payment page.
        </p>
        <p>If you see "Mandatory parameter missing", the form submission is still failing.</p>
      </div>
    </div>

    <script>
      // Your actual PayU configuration from database
      const PAYU_CONFIG = {
        merchant_key: 'rjQUPktU',
        salt_key: 'e5iIg1jwi8UnzIZJJP9hK43y9PNYvBKBSFMvVHrOHx',
      };

      function log(message) {
        const logDiv = document.getElementById('logOutput');
        const timestamp = new Date().toLocaleTimeString();
        logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(message);
      }

      // Generate SHA-512 hash for PayU (same as your backend)
      async function generatePayUHash(data) {
        // PayU hash format: key|txnid|amount|productinfo|firstname|email|udf1|udf2|udf3|udf4|udf5||||||SALT
        const hashString = [
          data.key,
          data.txnid,
          data.amount,
          data.productinfo,
          data.firstname,
          data.email,
          data.udf1 || '',
          data.udf2 || '',
          data.udf3 || '',
          data.udf4 || '',
          data.udf5 || '',
          '',
          '',
          '',
          '',
          '', // 5 empty fields as per PayU spec
          PAYU_CONFIG.salt_key,
        ].join('|');

        log(`Hash string: ${hashString}`);

        const encoder = new TextEncoder();
        const data_encoded = encoder.encode(hashString);
        const hashBuffer = await crypto.subtle.digest('SHA-512', data_encoded);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map((b) => b.toString(16).padStart(2, '0')).join('');

        log(`Generated hash: ${hashHex.substring(0, 20)}...`);
        return hashHex;
      }

      async function testPayUPayment() {
        log('ðŸ§ª Starting PayU test with correct keys...');

        const txnid = 'PAYU_CORRECT_TEST_' + Date.now();
        const productinfo = `Test Product (${txnid})`;

        const paymentData = {
          key: PAYU_CONFIG.merchant_key,
          txnid: txnid,
          amount: '100.00',
          productinfo: productinfo,
          firstname: 'Test User',
          email: 'test@example.com',
          phone: '9999999999',
          surl: 'https://example.com/success',
          furl: 'https://example.com/failure',
          udf1: '',
          udf2: '',
          udf3: '',
          udf4: '',
          udf5: '',
        };

        log('ðŸ“ Payment data prepared:');
        log(`- Key: ${paymentData.key}`);
        log(`- Transaction ID: ${paymentData.txnid}`);
        log(`- Amount: ${paymentData.amount}`);
        log(`- Product: ${paymentData.productinfo}`);

        // Generate proper hash
        log('ðŸ” Generating SHA-512 hash...');
        const hash = await generatePayUHash(paymentData);

        // Create and submit form
        log('ðŸ“‹ Creating payment form...');
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = 'https://test.payu.in/_payment';
        form.target = '_self';
        form.style.display = 'none';

        // Add all form fields
        Object.entries(paymentData).forEach(([key, value]) => {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = key;
          input.value = value;
          form.appendChild(input);
        });

        // Add hash field
        const hashInput = document.createElement('input');
        hashInput.type = 'hidden';
        hashInput.name = 'hash';
        hashInput.value = hash;
        form.appendChild(hashInput);

        // Add to page
        document.body.appendChild(form);

        log(`âœ… Form created with ${form.elements.length} fields`);
        log('ðŸš€ Submitting to PayU...');

        // Log form data for debugging
        console.log('=== PayU Form Data ===');
        const formData = new FormData(form);
        for (let [key, value] of formData.entries()) {
          console.log(`${key}: ${value}`);
        }

        // Submit form
        setTimeout(() => {
          form.submit();
        }, 1000);
      }

      // Initialize
      window.onload = function () {
        log('ðŸŽ¯ PayU test page loaded');
        log(`ðŸ“Š Using merchant key: ${PAYU_CONFIG.merchant_key}`);
        log('ðŸ”‘ Using correct salt key for hash generation');
        log('ðŸ‘† Click the button above to test PayU payment');
      };
    </script>
  </body>
</html>
